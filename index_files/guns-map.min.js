RegExp.escape=function(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&');};(function($){'use strict';$.csv={defaults:{separator:',',delimiter:'"',headers:true},hooks:{castToScalar:function(value,state){var hasDot=/\./;if(isNaN(value))return value;else if(hasDot.test(value))return parseFloat(value);else{var integer=parseInt(value);if(isNaN(integer))return null;else return integer;}}},parsers:{parse:function(csv,options){var separator=options.separator;var delimiter=options.delimiter;if(!options.state.rowNum)options.state.rowNum=1;if(!options.state.colNum)options.state.colNum=1;var data=[];var entry=[];var state=0;var value='';var exit=false;function endOfEntry(){state=0;value='';if(options.start&&options.state.rowNum<options.start){entry=[];options.state.rowNum++;options.state.colNum=1;return;}if(options.onParseEntry===undefined)data.push(entry);else{var hookVal=options.onParseEntry(entry,options.state);if(hookVal!==false)data.push(hookVal);}entry=[];if(options.end&&options.state.rowNum>=options.end)exit=true;options.state.rowNum++;options.state.colNum=1;}function endOfValue(){if(options.onParseValue===undefined)entry.push(value);else{var hook=options.onParseValue(value,options.state);if(hook!==false)entry.push(hook);}value='';state=0;options.state.colNum++;}var escSeparator=RegExp.escape(separator);var escDelimiter=RegExp.escape(delimiter);var match=/(D|S|\n|\r|[^DS\r\n]+)/;var matchSrc=match.source;matchSrc=matchSrc.replace(/S/g,escSeparator);matchSrc=matchSrc.replace(/D/g,escDelimiter);match=RegExp(matchSrc,'gm');csv.replace(match,function(m0){if(exit)return;switch(state){case 0:if(m0===separator){value+='';endOfValue();break;}if(m0===delimiter){state=1;break;}if(m0==='\n'){endOfValue();endOfEntry();break;}if(/^\r$/.test(m0))break;value+=m0;state=3;break;case 1:if(m0===delimiter){state=2;break;}value+=m0;state=1;break;case 2:if(m0===delimiter){value+=m0;state=1;break;}if(m0===separator){endOfValue();break;}if(m0==='\n'){endOfValue();endOfEntry();break;}if(/^\r$/.test(m0))break;throw new Error('CSVDataError: Illegal State [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');case 3:if(m0===separator){endOfValue();break;}if(m0==='\n'){endOfValue();endOfEntry();break;}if(/^\r$/.test(m0))break;if(m0===delimiter)throw new Error('CSVDataError: Illegal Quote [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');throw new Error('CSVDataError: Illegal Data [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');default:throw new Error('CSVDataError: Unknown State [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');}});if(entry.length!==0){endOfValue();endOfEntry();}return data;},splitLines:function(csv,options){var separator=options.separator;var delimiter=options.delimiter;if(!options.state.rowNum)options.state.rowNum=1;var entries=[];var state=0;var entry='';var exit=false;function endOfLine(){state=0;if(options.start&&options.state.rowNum<options.start){entry='';options.state.rowNum++;return;}if(options.onParseEntry===undefined)entries.push(entry);else{var hookVal=options.onParseEntry(entry,options.state);if(hookVal!==false)entries.push(hookVal);}entry='';if(options.end&&options.state.rowNum>=options.end)exit=true;options.state.rowNum++;}var escSeparator=RegExp.escape(separator);var escDelimiter=RegExp.escape(delimiter);var match=/(D|S|\n|\r|[^DS\r\n]+)/;var matchSrc=match.source;matchSrc=matchSrc.replace(/S/g,escSeparator);matchSrc=matchSrc.replace(/D/g,escDelimiter);match=RegExp(matchSrc,'gm');csv.replace(match,function(m0){if(exit)return;switch(state){case 0:if(m0===separator){entry+=m0;state=0;break;}if(m0===delimiter){entry+=m0;state=1;break;}if(m0==='\n'){endOfLine();break;}if(/^\r$/.test(m0))break;entry+=m0;state=3;break;case 1:if(m0===delimiter){entry+=m0;state=2;break;}entry+=m0;state=1;break;case 2:var prevChar=entry.substr(entry.length-1);if(m0===delimiter&&prevChar===delimiter){entry+=m0;state=1;break;}if(m0===separator){entry+=m0;state=0;break;}if(m0==='\n'){endOfLine();break;}if(m0==='\r')break;throw new Error('CSVDataError: Illegal state [Row:'+options.state.rowNum+']');case 3:if(m0===separator){entry+=m0;state=0;break;}if(m0==='\n'){endOfLine();break;}if(m0==='\r')break;if(m0===delimiter)throw new Error('CSVDataError: Illegal quote [Row:'+options.state.rowNum+']');throw new Error('CSVDataError: Illegal state [Row:'+options.state.rowNum+']');default:throw new Error('CSVDataError: Unknown state [Row:'+options.state.rowNum+']');}});if(entry!=='')endOfLine();return entries;},parseEntry:function(csv,options){var separator=options.separator;var delimiter=options.delimiter;if(!options.state.rowNum)options.state.rowNum=1;if(!options.state.colNum)options.state.colNum=1;var entry=[];var state=0;var value='';function endOfValue(){if(options.onParseValue===undefined)entry.push(value);else{var hook=options.onParseValue(value,options.state);if(hook!==false)entry.push(hook);}value='';state=0;options.state.colNum++;}if(!options.match){var escSeparator=RegExp.escape(separator);var escDelimiter=RegExp.escape(delimiter);var match=/(D|S|\n|\r|[^DS\r\n]+)/;var matchSrc=match.source;matchSrc=matchSrc.replace(/S/g,escSeparator);matchSrc=matchSrc.replace(/D/g,escDelimiter);options.match=RegExp(matchSrc,'gm');}csv.replace(options.match,function(m0){switch(state){case 0:if(m0===separator){value+='';endOfValue();break;}if(m0===delimiter){state=1;break;}if(m0==='\n'||m0==='\r')break;value+=m0;state=3;break;case 1:if(m0===delimiter){state=2;break;}value+=m0;state=1;break;case 2:if(m0===delimiter){value+=m0;state=1;break;}if(m0===separator){endOfValue();break;}if(m0==='\n'||m0==='\r')break;throw new Error('CSVDataError: Illegal State [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');case 3:if(m0===separator){endOfValue();break;}if(m0==='\n'||m0==='\r')break;if(m0===delimiter)throw new Error('CSVDataError: Illegal Quote [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');throw new Error('CSVDataError: Illegal Data [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');default:throw new Error('CSVDataError: Unknown State [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');}});endOfValue();return entry;}},toArray:function(csv,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;var state=(options.state!==undefined?options.state:{});var options={delimiter:config.delimiter,separator:config.separator,onParseEntry:options.onParseEntry,onParseValue:options.onParseValue,state:state};var entry=$.csv.parsers.parseEntry(csv,options);if(!config.callback)return entry;else config.callback('',entry);},toArrays:function(csv,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;var data=[];var options={delimiter:config.delimiter,separator:config.separator,onParseEntry:options.onParseEntry,onParseValue:options.onParseValue,start:options.start,end:options.end,state:{rowNum:1,colNum:1}};data=$.csv.parsers.parse(csv,options);if(!config.callback)return data;else config.callback('',data);},toObjects:function(csv,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;config.headers='headers' in options?options.headers:$.csv.defaults.headers;options.start='start' in options?options.start:1;if(config.headers)options.start++;if(options.end&&config.headers)options.end++;var lines=[];var data=[];var options={delimiter:config.delimiter,separator:config.separator,onParseEntry:options.onParseEntry,onParseValue:options.onParseValue,start:options.start,end:options.end,state:{rowNum:1,colNum:1},match:false};var headerOptions={delimiter:config.delimiter,separator:config.separator,start:1,end:1,state:{rowNum:1,colNum:1}};var headerLine=$.csv.parsers.splitLines(csv,headerOptions);var headers=$.csv.toArray(headerLine[0],options);var lines=$.csv.parsers.splitLines(csv,options);options.state.colNum=1;if(headers)options.state.rowNum=2;else options.state.rowNum=1;for(var i=0,len=lines.length;i<len;i++){var entry=$.csv.toArray(lines[i],options);var object={};for(var j in headers)object[headers[j]]=entry[j];data.push(object);options.state.rowNum++;}if(!config.callback)return data;else config.callback('',data);},fromArrays:function(arrays,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;config.escaper='escaper' in options?options.escaper:$.csv.defaults.escaper;config.experimental='experimental' in options?options.experimental:false;if(!config.experimental)throw new Error('not implemented');var output=[];for(i in arrays)output.push(arrays[i]);if(!config.callback)return output;else config.callback('',output);},fromObjects2CSV:function(objects,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;config.experimental='experimental' in options?options.experimental:false;if(!config.experimental)throw new Error('not implemented');var output=[];for(i in objects)output.push(arrays[i]);if(!config.callback)return output;else config.callback('',output);}};$.csvEntry2Array=$.csv.toArray;$.csv2Array=$.csv.toArrays;$.csv2Dictionary=$.csv.toObjects;})(jQuery);
$(document).ready(function(){var map=null;var layers=[];var stages=[];var stage=0;var bubble_template=null;var stage_numbers_template=null;var staged_point=null;var juvenile_data=null;var trequan_marker=null;var stage_numbers_el=$('#controls-stage-indicator');var stage_numbers_template_el=$('#stage_numbers_template');var stages_els=[];var map_text_el=$('#controls-text');var map_el_string='homicides_map';var tooltip_el=$('#homicides_map_tooltip');var bubble_template_el=$('#bubble-template');var btn_next_el=$('#controls-next');var btn_previous_el=$('#controls-prev');var table_el=$("#homicides_table");var JUVENILE_CSV='/includes/victims.csv';var INITIAL_CENTER=new L.LatLng(44.969,-93.164);var INITIAL_ZOOM=11;var BOUNDS_SW=new L.LatLng(44.730,-93.829);var BOUNDS_NE=new L.LatLng(45.216,-92.245);var BOUNDS=new L.LatLngBounds(BOUNDS_SW,BOUNDS_NE);var MIN_ZOOM=10;var MAX_ZOOM=14;var MAP_OPTIONS={center:INITIAL_CENTER,zoom:INITIAL_ZOOM,minZoom:MIN_ZOOM,maxZoom:MAX_ZOOM,maxBounds:BOUNDS};var TILES_DIR='http://ww2.startribune.com/maps/tiles/';var TONER_LAYER_VERSION=0.1;var TONER_LAYER_OPACITY=1.0;var TONER_LAYER_URL='http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png';var TONER_LAYER_SUBDOMAINS=['a','b','c','d'];var TONER_LAYER_ATTRIBUTION='Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>.<br />Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.';var TONER_LAYER_OPTIONS={opacity:TONER_LAYER_OPACITY,subdomains:TONER_LAYER_SUBDOMAINS,attribution:TONER_LAYER_ATTRIBUTION};var tonerLayer=new L.TileLayer(TONER_LAYER_URL,TONER_LAYER_OPTIONS);var OVERALL_LAYER_VERSION=0.4;var OVERALL_LAYER_OPACITY=0.8;var OVERALL_LAYER_URL=TILES_DIR+'tiles_guns/'+OVERALL_LAYER_VERSION+'/{z}/{x}/{y}.png';var OVERALL_LAYER_OPTIONS={opacity:OVERALL_LAYER_OPACITY};var TWIN_CITIES_CENTER=new L.LatLng(44.971,-93.126);var TWIN_CITIES_ZOOM=11;var NORTH_MINNEAPOLIS_CENTER=new L.LatLng(45.00558,-93.27452);var NORTH_MINNEAPOLIS_ZOOM=13;var PHILLIPS_CENTER=new L.LatLng(44.953,-93.259);var PHILLIPS_ZOOM=13;var PHILLIPS_THEN_ZOOM=14;var ST_PAUL_CENTER=new L.LatLng(44.959,-93.089);var ST_PAUL_ZOOM=12;var SYKES_CENTER=new L.LatLng(44.959,-93.250);var SYKES_ZOOM=14;var SYKES_MARKER=new L.Marker(new L.LatLng(44.959,-93.250));var tonerLayer=new L.TileLayer(TONER_LAYER_URL,TONER_LAYER_OPTIONS);var overallLayer=new L.TileLayer(OVERALL_LAYER_URL,OVERALL_LAYER_OPTIONS);function previousStage(){stage-=1;if(!(stage<0))setStage(stage);else stage=0;}function nextStage(){stage+=1;if(!(stage>=stages.length))setStage(stage);else stage=stages.length-1;}function setStage(i){stage=i;s=stages[i];if(s.center&&s.zoom){map.setView(s.center,s.zoom);if(s.then_zoom)setTimeout('map.setZoom(s.then_zoom);',200);}if(s.text)map_text_el.html('<p>'+s.text+'</p>');else map_text_el.html('');if(trequan_marker&&s.trequan)trequan_marker.openPopup();else if(trequan_marker)trequan_marker.closePopup();$('.homicides_stage_active').removeClass('homicides_stage_active');$('#homicides_stage_'+stage).addClass('homicides_stage_active');$('.homicides_button').addClass('homicides_button_active');if(i===0){$('.homicides_button_inactive').removeClass('homicides_button_inactive');btn_previous_el.removeClass('homicides_button_active');btn_previous_el.addClass('homicides_button_inactive');btn_next_el.addClass('homicides_button_active');}else if(i===stages.length-1){$('.homicides_button_inactive').removeClass('homicides_button_inactive');btn_next_el.removeClass('homicides_button_active');btn_next_el.addClass('homicides_button_inactive');}else{$('.homicides_button_inactive').removeClass('homicides_button_inactive');$('.controls-arrow').addClass('homicides_button_active');}}function handleClick(e){tooltip_el.hide();}function handleMouseover(e){var properties=e.target.properties;tooltip_el.html(properties.Name);tooltip_el.show();}function initMap(){map=new L.Map(map_el_string,MAP_OPTIONS);map.addLayer(tonerLayer);map.addLayer(overallLayer);bubble_template=_.template(bubble_template_el.html());$.get(JUVENILE_CSV,function(data){juvenile_data=$.csv.toObjects(data);var markers=[];var options={'radius':2,'fillColor':'#8e1d27','color':'#813','weight':10,'opacity':0,'fillOpacity':1};_.each(juvenile_data,function(e){var m=new L.CircleMarker([e.Lat,e.Lon],options);var birth_year_raw=e.BirthDate;var death_year_raw=e.DeathDate;var birth_year=birth_year_raw.slice(birth_year_raw.lastIndexOf('/')+1);var death_year=death_year_raw.slice(death_year_raw.lastIndexOf('/')+1);var data={'name':e.Name,'birth_year':birth_year,'death_year':death_year,'img_url':e.Photo_URL||"http://stmedia.startribune.com/images/gunVics_noPhoto.png",'text':e.About,'url':e.URL,'headline':e.Headline};m.properties=e;m.bindPopup(bubble_template(data));m.on({click:handleClick,mouseover:handleMouseover});markers.push(m);if(e.Name==='Trequan Martell Sykes')trequan_marker=m;});homicides_layer=L.layerGroup(markers).addTo(map);});};function initButtons(){btn_previous_el.click(function(){previousStage();});btn_next_el.click(function(){nextStage();});$.each(stages_els,function(i,id){$('#'+id).click(function(e){stage=i;setStage(i);});});};function initStages(){var stage0={center:INITIAL_CENTER,zoom:INITIAL_ZOOM,text:'Authorities seized these guns in a variety of situations: a drug bust, an arrest after a drive-by shooting, a welfare check on a suicidal man, serving a warrant, catching a felon carrying a weapon, an impounded vehicle, a man making terroristic threats, and firearms turned in by people who no longer want them.'};var stage1={center:NORTH_MINNEAPOLIS_CENTER,zoom:NORTH_MINNEAPOLIS_ZOOM,text:'A cluster of neighborhoods in North Minneapolis have the highest rate of gun seizures in the Twin Cities.'};var stage2={center:PHILLIPS_CENTER,zoom:PHILLIPS_ZOOM,then_zoom:PHILLIPS_THEN_ZOOM,text:'In South Minneapolis, gun seizures have been highest near the intersections of Cedar Avenue South and Hiawatha Avenue, East Franklin Avenue and Chicago Avenue South and portions of Lake Street.'};var stage3={center:PHILLIPS_CENTER,zoom:PHILLIPS_THEN_ZOOM,text:'Trequan Martell Sykes was shot to death June 1, 2012. His story is <a target="_blank" href="http://www.startribune.com/gunvictims">here</a>.',trequan:true};var stage4={center:ST_PAUL_CENTER,zoom:ST_PAUL_ZOOM,text:'In St. Paul, police have seen a concentration of gun seizures along University Avenue, downtown and portions of the East Side. City police say guns are increasingly easy for children to access in St. Paul. When they go into a class and ask young people how many could get a gun by the weekend, officers routinely see two thirds raise their hands.'};stages.push(stage0);stages.push(stage1);stages.push(stage2);stages.push(stage3);stages.push(stage4);stage_numbers_template=_.template(stage_numbers_template_el.html());stage_numbers_el.html(stage_numbers_template({'stages':stages}));$.each(stages,function(i,s){id='homicides_stage_'+i;stages_els.push(id);});}initMap();initStages();initButtons();setStage(0);});
